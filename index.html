<script>
let activeTab = "NASB";
let results = [];

// TAB SWITCH
function selectTab(e, tab) {
  activeTab = tab;
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  e.target.classList.add("active");

  const info = {
    NASB: "NASB selected — Cachebuster replacement only",
    ESBO: "ESBO selected — Cachebuster + GDPR rules",
    APAC: "APAC selected — Cachebuster replacement only"
  };
  document.getElementById("tabInfo").innerText = info[tab];
}

// MAIN FUNCTION
function replaceMacros() {
  const input = document.getElementById("input").value.trim();
  if (!input) return alert("Enter tags first");

  const lines = input.split("\n").map(l => l.trim()).filter(Boolean);
  results = [];

  const output = lines.map(url => {
    let replaced = url;

    // ================= RANDOM NUMBER MACROS (ALL TABS) =================
    const randomMacros = [
      /\[CACHEBUSTER\]/gi,
      /\[INSERT_CACHEBUSTER_HERE\]/gi,     // ✅ NEW
      /\[timestamp\]/gi,
      /\$\{timestamp\}/gi,
      /%%timestamp%%/gi,
      /\[INSERT_CACHEBREAKER_HERE\]/gi,
      /\[INSERT_MACRO\]/gi,
      /\[CACHBUSTER\]/gi,
      /\[CACHE_BREAKER\]/gi
    ];
    randomMacros.forEach(r => replaced = replaced.replace(r, "__RANDOM_NUMBER__"));

    // CacheBuster param (case insensitive)
    replaced = replaced.replace(/CacheBuster=[^&;]+/gi, "CacheBuster=__RANDOM_NUMBER__");
    replaced = replaced.replace(/Cachebuster=[^&;]+/gi, "Cachebuster=__RANDOM_NUMBER__"); // ✅ NEW

    // ================= DYNATA AdvertiserID RULE (ALL TABS) =================
    if (/dynata/i.test(replaced)) {
      replaced = replaced.replace(/AdvertiserID=[^&;]+/gi, "AdvertiserID=__DEVICE_UID__");
    }

    // ================= ESBO GDPR RULES =================
    if (activeTab === "ESBO") {

      // DoubleVerify visit.jpg → append at END with &
      if (replaced.includes("tps.doubleverify.com/visit.jpg")) {
        if (!replaced.includes("gdpr=${GDPR}")) {
          replaced += "&gdpr=${GDPR}&gdpr_consent=${GDPR_CONSENT_126}";
        }
      }

      // DCM → insert after tfua= with ;
      if (replaced.includes("ad.doubleclick.net/ddm/")) {
        const gdprString = "gdpr=${GDPR};gdpr_consent=${GDPR_CONSENT_755}";
        if (!replaced.includes("gdpr=${GDPR}")) {
          replaced = replaced.replace(/tfua=([^;]*)/i, (match, val) => {
            return `tfua=${val};${gdprString}`;
          });
        }
      }
    }

    results.push({ original: url, replaced });
    return replaced;
  });

  document.getElementById("output").value = output.join("\n");
}

// COPY BUTTON
function copyOutput() {
  const output = document.getElementById("output");
  output.select();
  document.execCommand("copy");
  alert("Copied to clipboard");
}

// CSV EXPORT
function downloadCSV() {
  if (!results.length) return alert("Run replacement first");

  let csv = "Original,Replaced\n";
  results.forEach(r => {
    csv += `"${r.original.replace(/"/g,'""')}","${r.replaced.replace(/"/g,'""')}"\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `macro_${activeTab}.csv`;
  link.click();
}
</script>
